# =============================================================================
# CONFIGURACIÓN DE LOGROTATE PARA SCRIPTS DE FICHAJE AUTOMÁTICO
# =============================================================================
# Archivo de configuración para la rotación de logs de los scripts de fichaje
# 
# INSTALACIÓN EN DEBIAN 12:
# 1. Copiar este archivo a: /etc/logrotate.d/auto-fichaje
# 2. Ajustar permisos: sudo chmod 644 /etc/logrotate.d/auto-fichaje
# 3. Verificar configuración: sudo logrotate -d /etc/logrotate.d/auto-fichaje
# 4. Forzar rotación de prueba: sudo logrotate -f /etc/logrotate.d/auto-fichaje
# =============================================================================

# Configuración para logs de fichajes automáticos
/opt/fichajes/scripts/logs/auto_fichaje.log
/opt/fichajes/scripts/logs/auto_fichaje_entrada.log
/opt/fichajes/scripts/logs/auto_fichaje_salida.log {
    
    # Rotación diaria de logs
    daily
    
    # Mantener logs de los últimos 30 días
    rotate 30
    
    # Comprimir logs antiguos para ahorrar espacio
    compress
    
    # No comprimir el log más reciente (para acceso rápido)
    delaycompress
    
    # No fallar si el archivo de log no existe
    missingok
    
    # No rotar archivos vacíos
    notifempty
    
    # Crear nuevo archivo de log después de la rotación
    create 0644 root root
    
    # Usar fechas en los nombres de archivos rotados
    dateext
    
    # Formato de fecha: YYYYMMDD
    dateformat -%Y%m%d
    
    # Script que se ejecuta después de la rotación
    postrotate
        # Reiniciar rsyslog si está disponible para refrescar handles de archivos
        if [ -f /var/run/rsyslogd.pid ]; then
            systemctl reload rsyslog > /dev/null 2>&1 || true
        fi
        
        # Opcional: Enviar señal a los scripts si están corriendo como daemons
        # En este caso, nuestros scripts son ejecutados por cron, no como daemons
        # por lo que no necesitamos enviar señales
        
        # Log de rotación completada
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Rotación de logs de fichaje completada" >> /var/log/logrotate.log
    endscript
    
    # Script que se ejecuta antes de la rotación
    prerotate
        # Crear directorio de logs si no existe
        mkdir -p /opt/fichajes/scripts/logs
        
        # Asegurar permisos correctos en el directorio
        chmod 755 /opt/fichajes/scripts/logs
        
        # Log de inicio de rotación
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Iniciando rotación de logs de fichaje" >> /var/log/logrotate.log
    endscript
}

# Configuración específica para logs de debugging (si existen)
/opt/fichajes/scripts/logs/debug_*.log {
    
    # Rotación semanal para logs de debug
    weekly
    
    # Mantener solo 4 semanas de logs de debug
    rotate 4
    
    # Comprimir inmediatamente
    compress
    
    # No fallar si no existe
    missingok
    
    # No rotar si está vacío
    notifempty
    
    # Crear nuevo archivo
    create 0644 root root
    
    # Usar fechas en nombres
    dateext
    dateformat -%Y%m%d
}

# =============================================================================
# NOTAS DE CONFIGURACIÓN
# =============================================================================
# 
# FRECUENCIAS DISPONIBLES:
# - daily: rotación diaria
# - weekly: rotación semanal
# - monthly: rotación mensual
# - yearly: rotación anual
# 
# OPCIONES DE COMPRESIÓN:
# - compress: comprimir logs rotados
# - nocompress: no comprimir
# - delaycompress: comprimir en la siguiente rotación
# - compresscmd: comando personalizado de compresión
# 
# GESTIÓN DE ARCHIVOS:
# - rotate N: mantener N archivos rotados
# - maxage N: eliminar archivos más antiguos de N días
# - size: rotar cuando el archivo alcance cierto tamaño
# 
# EJEMPLO DE CRON PERSONALIZADO:
# Si quieres ejecutar logrotate más frecuentemente que diario:
# */6 * * * * /usr/sbin/logrotate /etc/logrotate.d/auto-fichaje
# 
# VERIFICACIÓN:
# - Verificar sintaxis: sudo logrotate -d /etc/logrotate.d/auto-fichaje
# - Forzar rotación: sudo logrotate -f /etc/logrotate.d/auto-fichaje
# - Ver estado: sudo cat /var/lib/logrotate/status
# 
# =============================================================================
